<?php

/*
............DN............Z7........................................................................
............NI7...........?,I$..........................=$Z7??88....................................
............DZ8M,.........:,,,I.......................~NZI????????..................................
............=MMMD.......=M+=,,,,:....................?$??$$=??I??I?I................................
..............MMO8.....,DI+=,,,,?:..................?M?O?N?+OZ7N?I??................................
.............,+=I$...,N$+I++~,,,:+..................88$87     Z    ?7...............................
..Z+?.........MMM877II+?I$7I++Z?,:=.................7MMMM$778D8$MMZN??..............................
..?:~I+=....~?MM~~?I7?II$$7I77:7,,O...............I$NNZ8M   MMM   MM?7..............................
..,,+NM8II$7II8MI:+???+?ZZODI?=I,,8=..............8NMN7 77ZZI7ZZ$NMD ?..............................
..,,IMMDO877I?$MM8+?II?+7OZ7D8II,,Z~..............NMODM$  8DOZZOMM  ZOO.............................
..~,IMNNOD7III7OMM:+II77DDDMDDZ+,,Z~..............MNZM8$7Z        ZMMNM.............................
..I,:ZMD8OIIIIII$M7+DMM$.....=MD,~8..............:M8ZMNZ$$NNDOZZNMMMMMO.............................
..=D:~MZ$OZZI7I?+$OM?+$M........$I..................7OMMM??I7ZOMMMMMM$..............................
....I+7$Z8O8OO??D:.:MMMMM~...........................7NMMNMMMMMMMMZ................................
....~,:+8ZO8ODDD....7MZMMI............................DDO8ZZNMNZ8MNMMMMD,...........................
.....?,,:?Z7$M........MM=7....................IMMNDM7$MD$$$ZZOZZMMMMNMMMDNZNMMDODNN$................
......+,,:+$N.........7MOO=.................:8DNM8ZN7ZZ$Z7OZMOZZ8NMZ8O$IMM8O$Z$$Z$ZNMN..............
.......+,,:~7..........D+=~?.,...........ZN88DDZMM8OZZ$7DZ777ZZZNMNMD8ODMMM8Z$777ZZOMD8=............
..........I78.........8=?Z8OOO=.......=M7?7$NMMDMMM8MOI??7==?I$D77MMMDMMZZMM88Z=~+7ZZ8Z?:...........
......................7Z$I7778~......:Z+=IZ8ZZ8M7777$MI77I~=?7MMO$Z$$MNZZZZZNNN7=~IZZZZ7D...........
.....................?O7I7$77$?.....,M+=Z$ZZ$7I$OMNDDN8ZZ$~+7ZDDMMMOMM?7$ZZZZZN8$777Z$ZZNZ..........
.....................,MMI?Z$8MDO....7O?7Z7?=????M8MMZZMMZZMIMOION8ZM+~~?ZZZZZZMMZZ$Z$$ZZM87?8.......
......................8$8$$$IZMM....=D7Z$7=~~+??$N7$I7DNMMMMN7I777MI~:I7$ZZZZZNMNN8OZZZZ8MZZ?$......
......................DZ787$8MMM.....O88$7+~~=??7ZM$777$77O777I77OI==?I7$ZZZZZMM8Z$$ZZZZ$7ZZ$7=.....
......................=OO8O8MM7+7.$M7?7$M$?+=~??7$M8I7NMMM8M77$$MN+?77$$ZZZZONMMO7=~?77$+IZZZZO$....
.......................IONND$M7I$~8I~++IDMZ$8NOIZ$M8$NMMMMMNMM7ZM877$8D8ZZZOMMMM8?~~~=+==7ZZZZ8M....
........................NDMN$88?IDI=~~+?Z8MMN8OOODMNMMNM$8MNND7$MMZ8DDMMMMMMM8DMMM=:=+=~~?ZZZZ$M....
........................MMMMZ$NM+ID7??I7ZZMMMMZZZZM88MMMMMMMMM$7MZZ7$ZZZ8MDIZZZZMMMMMM$Z777ZZZZ$=...
........................8DMMN8MM8?OMN8$$ZZMMMDZ$Z88O7ZZMMMMM$7$ZNI7III$ZMMMMOZZ8N,..ZN8NDOZOZZZ7=...
..........................DNMMN8M7IZZZNOO8MMOZI7DMO$7$7$ZO8O$$$$DM$$ZZ7O88MO88NM....INZ7==?$ZZMZZ...
...........................OMMNO7M+?D8Z8MMO8MMNM7$77ZZDMNMMM8O77IZNMZ$Z8MNMDDNN:..N7I7ZZZZZZMMMMM:..
............................MM$$7$$+?DZZMMMMMMMN$7$Z$Z8????IMM$77$O8MM8DNMMMMD...$7$8ZZ8Z88MMMDNM7..
............................MMZOZ$MD?IOZMMD?MMMMMM87N8?==?++7OMO7$$OMMMMMMMM~...=N8ZZZZZZZZ8N8MM....
............................=MMMMMIM$I8NM7..+MMMMMMM$77$ZO8OZZDMMM8MMMMMMMMM=Z8ZII?I$ZO8ZZO8M8......
..............................DMMMNO8?$D,....:MMMMMMMDZZI78DN88DNMMMMMMMMMMM$?=?7$ZZZZ8NMMMM........
................................:DMMMM?I=.....?M77ZZI7?+???++7$ZZZMMMMMMMMD7??$ZZZZZNM8DMZ..........
.....................................,8?O7....MM7?7OMN$ZZZ88OZZO8NMMMMMM8DOZZN88MMNN8?..............
......................................O7?Z...=NN8D8DDNM88NNNMMNNMMDN8ONMOOZZZ8MMMO..................
.......................................DI7?.~M$$$Z$7$ONNOZ$$Z$$ZZ$$$8$MMDOOZZON,....................
........................................DDZ$8N87MODD$NM$$$88O7M$$O$ZNMONNOZ8MD......................
........................................OM8DMO7$MMMNOM8Z8ZN8O78MNO$$$ZNMMMNM........................
..........................................MMMMMMOO$$$DNMMNDZ$7$$88NMMMMMMMMN........................
..........................................=MMMMMNNMMD$ZONMMN8ZZOMMMMMMMMMMM.........................
..........................................:MMMMMNMNDNNMMMMNOOMMMMMMMMMMNZMD.........................
..........................................Z7MNMMMMMDNNDNNNMNNMMMMMMMD7D$Z7M~........................
........................................$88M=+?7MMMMMDDNNNMMMMMMMMZ=+??O$ZIN........................
........................................ZINI?II77ZMMMMMMNNMNMMMMNDI?~?7?ZZ7?7.......................
.......................................877$?7ID=?IIOMMMMMMNMMMD$7787+?7777ZI8=......................
......................................N$78$ZDO~~777?ZMMMMMMMMM$7II$ZZ7Z7Z?Z$=8......................
......................................8+$8ZZZ+~?7$I?I78MMMMMMMZ$7I?$ZOZ$I?ZZ?I......................
.....................................,7+7DZ7=~?7Z$?+$Z$DMMMMNM8Z$I+?$ZOD~=$ZI?:.....................
.....................................Z7=?OOI~:I7Z$??8$7Z?...NI8M$7???IZN7I$Z7II.....................
.....................................Z7??7NI~~77ZZ?DZZ7N....NN$D$7??~+7ZZ?7$$77.....................
.....................................D$7?$O?~~7ZZ$IDZZMD....:M88$7??~=7$7I$$Z7M,....................
.....................................$7I7Z7?~=7$ZZZNMM~.......NMD$??~~77$$$ZZ7M,....................
.....................................~$$7Z$?+?7ZZZ8MMO.........:MOI?~=7$ZZZZZ$M.....................
......................................Z7$ZZ$?I7ZZZMM=...........D87I=?$ZZZZZZN8.....................
......................................DD$ZZ$$$ZZZZMM.............O$7?7ZZZZM88M:.....................
......................................,MMOZZ$$ZZZZMO.............7Z$$ZZZZOMMMM......................
........................................M8ZOZZZZOMM?.............,NZ$ZZZ$8ZNMM......................
........................................MOZOZ88DMMN...............DMD8O8N8ZZMN......................
.......................................=87$ZMMMMM87................8MMMMO$ZZ8M......................
.......................................O7+7$8MMMZN:.................MMMMI+$ZZ8=.....................
......................................ND?+$Z77ZZ8M..................:MMM8?+7ZMNN....................
.....................................:O8NZZZDNZ7N.....................MMMMOZOMNNM=..................
.....................................?OZNZZOMD78.......................ZNN8ZMM88Z8,.................
.....................................$$ZMDZZZ$M=........................DMO8MMZ$OZOM................
....................................ZZZ8MNZZZ8M=........................8NMZ7ZZ$MZZ88...............
....................................$?77O8ZZNNMM........................ZZMD$ZZZM888M$..............
...................................?77D7$ZZZ8ZMM........................$ZZ8ZZZ8DZMMNM..............
................................,Z8$7$777$ZZOOMM........................M8ZOMNOZ8MZDNM~.............
................................8O?=????IZZ8OO8?Z7......................MMZZ77777I77~~MN............
................................DM+??????N++OOI7$8......................M$+++=++?++?I?OZ............
................................I$ZDOOOZMOI?OM78N+.....................?MM?I??+?8?+?NZMD............
.................................IMMNMMMMNMDMDMM$N.....................~8ZDOD7IDOMO7MMMD............
..................................=MMMMMMNNMM$$..........................~MMMMMNMMMMMM8.............
...................................DMMMMDDMMND..............................MMMDNMNMMMZ.............
...................................DMMN8MMMMM8..............................MMMMN8MMMM7.............
...................................DMMMMNMMMI................................IMMNMDNMM~.............
...................................,MMMMNNMM..................................MMMMMNMN..............
....................................MMMMMMMD..................................,MMMMMMM..............
....................................NMMMDMMM...................................NNNNDMM..............
....................................8MNNNMMM..................................~MMMMMMM:.............
....................................NMMMNMMM?.................................NMMMNNMMD.............
..................................MMMMMMNNNDM~................................MMMMMMMNMM7...........
...............................?MMMMMMMNMMMMM?................................MMMMMMMMMMO$..........
............................OMMMMMMMMMMMMMMMN.................................MMMMNNMMMMD8..........
.........................7MMMMMMMMMMMM$=.......................................7MMMM8Z7I............
.........................:MMMMMMMD=.................................................................
....................................................................................................
 */

//* FUNCTIONS.PHP
//* ALL OF THIS IS EXECUTED AT RUNTIME 


/* COMPOSER */
require_once('vendor/autoload.php');

/**
 * Roots includes
 */
$roots_includes = array(
  '/lib/utils.php',           // Utility functions
  '/lib/init.php',            // Initial theme setup and constants
  '/lib/wrapper.php',         // Theme wrapper class
  '/lib/sidebar.php',         // Sidebar class
  '/lib/config.php',          // Configuration
  '/lib/activation.php',      // Theme activation
  '/lib/titles.php',          // Page titles
  '/lib/cleanup.php',         // Cleanup
  '/lib/nav.php',             // Custom nav modifications
  '/lib/gallery.php',         // Custom [gallery] modifications
  '/lib/comments.php',        // Custom comments modifications
  '/lib/relative-urls.php',   // Root relative URLs
  '/lib/widgets.php',         // Sidebars and widgets
  '/lib/scripts.php',         // Scripts and stylesheets
  '/lib/custom.php',          // Custom functions
);
$jomi_includes = array(
  '/lib/jomi/admin.php', // admin usability and visual improvements
  '/lib/jomi/article_access.php',
  '/lib/jomi/article_count.php',  // count # of articles published/preprinted
  '/lib/jomi/db_switch.php', // db switch utility on dashboard
  '/lib/jomi/institution_import.php', // import institutions from CRM (WIP)
  '/lib/jomi/login.php', // login page utility and restyling
  '/lib/jomi/post_status.php', // register post statuses
  '/lib/jomi/post_types.php', // register post types (article)
  '/lib/jomi/rewrite.php', // rewrite rules for article
  '/lib/jomi/sidebars.php' // custom sidebars
);

$includes = array_merge($roots_includes, $jomi_includes);

foreach($includes as $file){
  if(!$filepath = locate_template($file)) {
    trigger_error("Error locating `$file` for inclusion!", E_USER_ERROR);
  }

  require_once $filepath;
}
unset($file, $filepath);

// Bug testing only. Not to be used on a production site!!
/*add_action('wp_footer', 'roots_wrap_info');

function roots_wrap_info() {  
  $format = '<h6>The %s template being used is: %s</h6>';
  $main   = Roots_Wrapping::$main_template;
  global $template;

  printf($format, 'Main', $main);
  printf($format, 'Base', $template);
}*/



/**
 * ARTICLE ACCESS MANAGEMENT
*/

// embed the javascript file that makes the AJAX request
wp_enqueue_script( 'my-ajax-request', plugin_dir_url( __FILE__ ) . 'js/ajax.js', array( 'jquery' ) );
 
// declare the URL to the file that handles the AJAX request (wp-admin/admin-ajax.php)
wp_localize_script( 'my-ajax-request', 'MyAjax', array( 'ajaxurl' => admin_url( 'admin-ajax.php' ) ) );

add_action( 'wp_ajax_nopriv_myajax-submit', 'myajax_submit' );
add_action( 'wp_ajax_myajax-submit', 'myajax_submit' );

function myajax_submit() {
  // get the submitted parameters
  $cat_id = (isset($_POST['cat'])) ? $_POST['cat'] : '';

  $args = array(
    'post_type' => 'article',
    'cat' => $cat_id
  );

  $query = new WP_Query($args);

  if(!$query->have_posts()) {
   // return nothing
  }
  while($query->have_posts()) {
    $query->the_post();
    echo the_title() . '<br>';
  }
  wp_reset_query();

  // IMPORTANT: don't forget to "exit"
  exit;
}



// custom settings page
// global rulebook
add_action('admin_menu', 'global_rulebook_menu');
function global_rulebook_menu(){
  add_options_page( "Global Access Rulebook", "Global Access Rulebook", "manage_options", "global_rulebook", "global_rulebook");
}
function global_rulebook(){
  echo "hello";
  ?>

  <h4>Category</h4>
  <select id="category">
    <option val="all">All</option>
  <?php
  $args = array(
    'type' => 'article',
    'hide_empty' => 1
  );
  $categories = get_categories($args);
  foreach($categories as $category) { ?>
    <option value="<?php echo $category->cat_ID; ?>"><?php echo $category->name; ?></option>
  <?php } ?>
  </select>

  <div id="results">
  </div>

  <script type="text/javascript" src="/wp-content/themes/jomi/assets/js/scripts.min.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script>
  $(function(){
    $('#category').change(function() {

      $('#results')
        .empty()
        .html("<p>nope</p>");

      $.post(
        // see tip #1 for how we declare global javascript variables
        MyAjax.ajaxurl,
        {
            // here we declare the parameters to send along with the request
            // this means the following action hooks will be fired:
            // wp_ajax_nopriv_myajax-submit and wp_ajax_myajax-submit
            action : 'myajax-submit',

            // other parameters can be added along with "action"
            //postID : MyAjax.postID,

            cat : $('#category').val()
        },
        function( response ) {
          $('#results').html(response);
        }
    );

    });
  });
  </script>
  <?php
}

/**
 * Adds a box to the main column on the Post and Page edit screens.
 */

function block_filter_add_meta_box() {

  $screens = array( 'article' );

  foreach ( $screens as $screen ) {

    add_meta_box(
      'block_filter_sectionid',
      'Block Filtering',
      'block_filter_meta_box_callback',
      $screen
    );
  }
}
add_action( 'add_meta_boxes', 'block_filter_add_meta_box' );

/**
 * Prints the box content.
 * 
 * @param WP_Post $post The object for the current post/page.
 */
function block_filter_meta_box_callback( $post ) {

  // Add an nonce field so we can check for it later.
  wp_nonce_field( 'block_filter_meta_box', 'block_filter_meta_box_nonce' );

  /*
   * Use get_post_meta() to retrieve an existing value
   * from the database and use the value for the form.
   */
  $value = get_post_meta( $post->ID, '_my_meta_value_key', true );

  /*echo '<label for="myplugin_new_field">';
  _e( 'Description for this field', 'myplugin_textdomain' );
  echo '</label> ';
  echo '<input type="text" id="myplugin_new_field" name="myplugin_new_field" value="' . esc_attr( $value ) . '" size="25" />';*/

?>

<h3>

<h4>Filter by Country. Uses <a href="http://en.wikipedia.org/wiki/ISO_3166-1" target="_blank">ISO alpha-2 country codes.</a> Separate by commas.</h4>
<input type="radio" name="filter_country_list_type" value="whitelist"> Whitelist<br>
<input type="radio" name="filter_country_list_type" value="blacklist"> Blacklist
<br>
<input type="text" id="filter_country" name="filter_country" placeholder="US,UK,FR,SE" size="25" />

<h4>Filter by Continent</h4>
<input type="checkbox" name="filter_continent_All" value="All" checked="true">All<br>
<input type="checkbox" name="filter_continent_AF" value="AF">Africa<br>
<input type="checkbox" name="filter_continent_AN" value="AN">Antarctica<br>
<input type="checkbox" name="filter_continent_AS" value="AS">Asia<br>
<input type="checkbox" name="filter_continent_EU" value="EU">Europe<br>
<input type="checkbox" name="filter_continent_NA" value="NA">North America<br>
<input type="checkbox" name="filter_continent_OC" value="OC">Oceania<br>
<input type="checkbox" name="filter_continent_SA" value="SA">South America<br>

<h4>Filter by IP</h4>
<input type="radio" name="filter_ip" value="verify">Only Verified IPs<br>
<input type="radio" name="filter_ip" value="no_verify" checked="true">Any IP<br>

<h4>Filter by User</h4>
<input type="radio" name="filter_user" value="verify">Only Logged-In Users<br>
<input type="radio" name="filter_user" value="no_verify" checked="true">Anyone<br>


<?php 
}

/**
 * When the post is saved, saves our custom data.
 *
 * @param int $post_id The ID of the post being saved.
 */
function block_filter_save_meta_box_data( $post_id ) {

  /*
   * We need to verify this came from our screen and with proper authorization,
   * because the save_post action can be triggered at other times.
   */

  // Check if our nonce is set.
  if ( ! isset( $_POST['block_filter_meta_box_nonce'] ) ) {
    return;
  }

  // Verify that the nonce is valid.
  if ( ! wp_verify_nonce( $_POST['block_filter_meta_box_nonce'], 'block_filter_meta_box' ) ) {
    return;
  }

  // If this is an autosave, our form has not been submitted, so we don't want to do anything.
  if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
    return;
  }

  // Check the user's permissions.
  if ( isset( $_POST['post_type'] ) && 'page' == $_POST['post_type'] ) {

    if ( ! current_user_can( 'edit_page', $post_id ) ) {
      return;
    }

  } else {

    if ( ! current_user_can( 'edit_post', $post_id ) ) {
      return;
    }
  }

  /* OK, it's safe for us to save the data now. */
  
  // Make sure that it is set.
  //if ( ! isset( $_POST['myplugin_new_field'] ) ) {
  //  return;
  //}

  // Sanitize user input.
  //$my_data = sanitize_text_field( $_POST['myplugin_new_field'] );

  // Update the meta field in the database.
  //update_post_meta( $post_id, '_my_meta_value_key', $my_data );
}
add_action( 'save_post', 'block_filter_save_meta_box_data' );

?>